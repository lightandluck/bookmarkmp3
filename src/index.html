<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>BookmarkMP3</title>
        <link rel="shortcut icon" href="https://s.yimg.com/wv/images/56af96d7a902556c1c538b161c86bf75_64.jpg">
        <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script>
            (function(window){
                window.utils = {
                    parseQueryString: function(str) {
                    var ret = Object.create(null);

                    if (typeof str !== 'string') {
                        return ret;
                    }

                    str = str.trim().replace(/^(\?|#|&)/, '');

                    if (!str) {
                        return ret;
                    }

                    str.split('&').forEach(function (param) {
                        var parts = param.replace(/\+/g, ' ').split('=');
                        // Firefox (pre 40) decodes `%3D` to `=`
                        // https://github.com/sindresorhus/query-string/pull/37
                        var key = parts.shift();
                        var val = parts.length > 0 ? parts.join('=') : undefined;

                        key = decodeURIComponent(key);

                        // missing `=` should be `null`:
                        // http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters
                        val = val === undefined ? null : decodeURIComponent(val);

                        if (ret[key] === undefined) {
                        ret[key] = val;
                        } else if (Array.isArray(ret[key])) {
                        ret[key].push(val);
                        } else {
                        ret[key] = [ret[key], val];
                        }
                    });

                    return ret;
                    }
                };
                })(window);

        </script>
    </head>
    <body>
        <nav>
            <ul>
                <li><a href="#">Home</a></li>
                <li id="sign-in" class="active"><a href="#">Sign In</a></li>
                <li id="sign-out" class="inactive"><a href="#">Sign Out</a></li>
            </ul>
        </nav>
        <main>
            <div id="pre-auth-section" style="display:none;">
                <p>This example takes the user through Dropbox's API OAuth flow using <code>Dropbox.getAuthenticationUrl()</code> method [<a href="http://dropbox.github.io/dropbox-sdk-js/Dropbox.html#getAuthenticationUrl">docs</a>] and then uses the generated access token to list the contents of their root directory.</p>
                <a href="" id="authlink" class="button">Authenticate</a>
                <p class="info">Once authenticated, it will use the access token to list the files in your root directory.</p>
            </div>

            <div id="authed-section" style="display:none;">
                <p>You have successfully authenticated. Below are the contents of your root directory. They were fetched using the SDK and access token.</p>
                <ul id="files"></ul>
            </div>

            <section class="files">
                
                <h2>Files</h2>
                

                </ul>
            </section>
            <section class="player">
                <h2>Player</h2>
                <audio src="https://dl.dropboxusercontent.com/apitl/1/AADprcKrDjfrHQH3r5nuO3_j7ggXosohboPx3exOtyMQuktjUDPxK8KRAmgHBqDscVBPROdrKKdAHy5YXUFKOc4GZYamvMv9i2HhM-obbuSk_-7T_kvRKCmo4cHQpPq8Jbr-K0LUbAHRkUh44FfABn4xgjW6fKeIpzlNpMevOZbWv2EZuvweqE8V46GwpnNh4c3qxERUaB5xIV3bfuKTQEriQXYBKRNFznan8iWj7Z-ErQ" controls>
                    
                </audio>
            </section>
        </main>

        <script>
            var CLIENT_ID = '47ekkmluwwcvrqj';

            // Parses the url and gets the access token if it is in the urls hash
            function getAccessTokenFromUrl() {
            return utils.parseQueryString(window.location.hash).access_token;
            }

            // If the user was just redirected from authenticating, the urls hash will
            // contain the access token.
            function isAuthenticated() {
            return !!getAccessTokenFromUrl();
            }

            // Render a list of items to #files
            function renderItems(items) {
            var filesContainer = document.getElementById('files');
            var album = "/Bucky"

            items.forEach(function(item) {
                var p = getUrlData(album, item.name);
                p.then(function() {
                    var li = document.createElement('li');
                    var a = document.createElement('a');
                    a.href = p._result.link;
                    a.text = item.name                
                    li.appendChild(a);
                    filesContainer.appendChild(li);
                })                
            });
            }

            var getUrlData = function(album, name) {
                var path;
                path = album + '/' + name;
                var pathObj = { path: path }
                return dbx.filesGetTemporaryLink(pathObj) 
            };
            function htmlEncode(value){
            //create a in-memory div, set it's inner text(which jQuery automatically encodes)
            //then grab the encoded contents back out.  The div never exists on the page.
            return $('<div/>').text(value).html();
            }

            function htmlDecode(value){
            return $('<div/>').html(value).text();
            }
            // This example keeps both the authenticate and non-authenticated setions
            // in the DOM and uses this function to show/hide the correct section.
            function showPageSection(elementId) {
            document.getElementById(elementId).style.display = 'block';
            }

            if (isAuthenticated()) {
            showPageSection('authed-section');

            // Create an instance of Dropbox with the access token and use it to
            // fetch and render the files in the users root directory.
            var dbx = new Dropbox({ accessToken: getAccessTokenFromUrl() });
            dbx.filesListFolder({path: '/Bucky'})
                .then(function(response) {
                renderItems(response.entries);
                })
                .catch(function(error) {
                console.error(error);
                });
            } else {
            showPageSection('pre-auth-section');

            // Set the login anchors href using dbx.getAuthenticationUrl()
            var dbx = new Dropbox({ clientId: CLIENT_ID });
            var authUrl = dbx.getAuthenticationUrl('http://localhost:9002/');
            document.getElementById('authlink').href = authUrl;
            }
        </script>

        
    </body>
</html>